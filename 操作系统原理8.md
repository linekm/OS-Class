### 操作系统原理8

#### Windows进程控制

```c++
BOOL CreateProcess(
    LPCTSTR lpApplicationName,     // 可执行程序名
    LPTSTR lpCommandLine,     //[可执行程序名]程序参数LPSECURITY_ATTRIBUTES lpProcessAttributes,
    LPSECURITY_ATTRIBUTES lpThreadAttributes, 
    BOOL bInheritHandles, 
    DWORD dwCreationFlags,    //创建标志
    LPVOID lpEnvironment, 
    LPCTSTR lpCurrentDirectory, 
    LPSTARTUPINFO lpStartupInfo,
    LPPROCESS_INFORMATION lpProcessInformation 
);  // lpProcessInformation :接收新进程的识别信息

```

#### Linux进程控制
**创建进程--fork()函数**
```c
#include <sys/types.h>
#include <unistd.h>
pid_t   fork(void);

```

**父进程和子进程**

父进程：fork的调用者
子进程：新建的进程

***子进程是父进程的复制。***
***父进程和子进程并发运行。***

**fork()执行流程**
1. 分配task_struct结构
2. 为新进程堆栈分配物理页。

3. 拷贝父进程的内容
    - 正文段、用户数据段及系统数据段task_struct的大部分内容，并对子进程中有别于父进程的项进行初始化。
  
4. 把新进程的task_struct结构地址保存在task指针数组中。
5. 子进程由fork(  )创建后，通常处于就绪状态。

**子进程执行fork()后的代码**

**init进程**
 - 所有进程由fork()函数创建。
 - 例外：init进程(1号进程)

**fork()执行声明**
*/kernel/fork.c*
```c
 int do_fork (
    unsigned long clone_flags, 
    unsigned long stack_start,
    struct pt_regs *regs, 
    unsigned long stack_size
 );
 ```

**Linux第一个进程为init进程**
**所有进程都是init子孙进程**

#### 线程
**概念**
- 线程是可由CPU直接运行的实体；
- 一个程序可以创建多个线程；
- 多个线程共享CPU可以实现并发运行。

**Windows创建线程**

![屏幕快照 2019-03-20 11.35.23.png-474.1kB][1]

**多线程适用场景**
 -  程序的多个功能需要并发运行
 -  提高窗口程序的交互性
 -  需要改善程序结构的地方
 -  多核CPU上的应用，充分发挥多核性能


[1]: http://static.zybuluo.com/linekm/76pnsrivpa8nkxoxpq9xwvz1/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-03-20%2011.35.23.png

